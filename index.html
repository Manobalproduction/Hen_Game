<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    canvas.width = 400;
    canvas.height = 800;

    // Game variables
    let mario;
    let gravity = 0.18; // Slower gravity
    let jumpStrength = -3.6; // Slower jump
    let isJumping = false;
    let gameStarted = false;
    let gameOver = false;
    let platforms = [];
    let obstacles = [];
    let scrollOffset = 0;

    // Initialize Platforms and Obstacles
    function initPlatforms() {
        platforms = [
            { x: 0, y: canvas.height - 200, width: 150, height: 20 },
            { x: 200, y: canvas.height - 300, width: 100, height: 20 },
            { x: 400, y: canvas.height - 250, width: 120, height: 20 },
        ];
    }

    function initObstacles() {
        obstacles = [
            { x: 300, y: canvas.height - 220, width: 30, height: 30 },
        ];
    }

    // Initialize Mario and start the game
    function init() {
        initPlatforms();
        initObstacles();

        mario = {
            x: 50,
            y: platforms[0].y - 40, // Align Mario to the first platform
            width: 40,
            height: 40,
            velocityY: 0,
        };

        scrollOffset = 0;
        gameOver = false;
        gameStarted = false;
        document.getElementById("startButton").style.display = "none";
        document.getElementById("retryButton").style.display = "none";
        update();
    }

    // Draw Mario
    function drawMario() {
        ctx.fillStyle = "blue";
        ctx.fillRect(mario.x - scrollOffset, mario.y, mario.width, mario.height);
    }

    // Draw platforms
    function drawPlatforms() {
        ctx.fillStyle = "#8B4513";
        platforms.forEach(platform => {
            ctx.fillRect(platform.x - scrollOffset, platform.y, platform.width, platform.height);
        });
    }

    // Draw obstacles
    function drawObstacles() {
        ctx.fillStyle = "red";
        obstacles.forEach(obstacle => {
            ctx.fillRect(obstacle.x - scrollOffset, obstacle.y, obstacle.width, obstacle.height);
        });
    }

    // Game update loop
    function update() {
        if (gameOver) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (gameStarted) {
            mario.y += mario.velocityY;
            mario.velocityY += gravity; // Apply slower gravity

            // Adjust scrollOffset if Mario moves beyond the center
            if (mario.x > canvas.width / 2) {
                scrollOffset = mario.x - canvas.width / 2;
            }

            // Check for platform collisions
            let isOnPlatform = false;
            platforms.forEach(platform => {
                if (
                    mario.x + mario.width > platform.x &&
                    mario.x < platform.x + platform.width &&
                    mario.y + mario.height >= platform.y &&
                    mario.y + mario.height <= platform.y + 10 && // Allow small tolerance
                    mario.velocityY >= 0
                ) {
                    mario.velocityY = 0;
                    mario.y = platform.y - mario.height;
                    isJumping = false;
                    isOnPlatform = true;
                }
            });

            // Check for obstacle collisions
            obstacles.forEach(obstacle => {
                if (
                    mario.x + mario.width > obstacle.x &&
                    mario.x < obstacle.x + obstacle.width &&
                    mario.y + mario.height > obstacle.y &&
                    mario.y < obstacle.y + obstacle.height
                ) {
                    gameOverFunction();
                }
            });

            // Mario falls off the screen
            if (!isOnPlatform && mario.y > canvas.height) {
                gameOverFunction();
            }

            // Remove off-screen platforms and obstacles
            platforms = platforms.filter(platform => platform.x + platform.width > scrollOffset);
            obstacles = obstacles.filter(obstacle => obstacle.x + obstacle.width > scrollOffset);

            // Generate new platforms
            if (platforms[platforms.length - 1].x < scrollOffset + canvas.width) {
                platforms.push({
                    x: platforms[platforms.length - 1].x + 200 + Math.random() * 200,
                    y: canvas.height - 150 - Math.random() * 300,
                    width: 100 + Math.random() * 50,
                    height: 20,
                });
            }

            // Generate new obstacles
            if (obstacles.length < 3 && Math.random() < 0.01) {
                obstacles.push({
                    x: scrollOffset + canvas.width + Math.random() * 200,
                    y: canvas.height - 220,
                    width: 30,
                    height: 30,
                });
            }
        }

        drawPlatforms();
        drawObstacles();
        drawMario();

        requestAnimationFrame(update);
    }

    function gameOverFunction() {
        gameOver = true;
        document.getElementById("retryButton").style.display = "block";
    }

    document.getElementById("startButton").addEventListener("click", () => {
        init();
    });

    document.getElementById("retryButton").addEventListener("click", () => {
        init();
    });

    document.getElementById("jumpButton").addEventListener("click", () => {
        if (!gameStarted) gameStarted = true;
        if (!isJumping) {
            mario.velocityY = jumpStrength; // Jump with reduced strength
            isJumping = true;
        }
    });

    document.getElementById("startButton").style.display = "block";
</script>
